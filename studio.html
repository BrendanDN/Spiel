<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>ivecodestream</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/gun/lib/yson.js"></script> -->
  <script src="https://cdn.jsdelivr.net/gh/QVDev/GunStreamer@0.0.9/js/GunStreamer.js"></script>
  <link rel="shortcut icon" href="../images/icons/favicon.ico">
</head>

<body>
  <div>
    <label for="title">Stream Title: </label>
    <input type="text" id="title" name="title">
  </div>
  <section></section>
</body>
<script src="js/wbs.js"></script>
<script src="js/stores.js"></script>
<script src="js/recorder.js"></script>
<script>
    const YOUR_ID = getID();

    const OPTS = {
      output: {
        width: 1280,  // resolution of the output stream
        height: 720,
        fps: 16       // frames per second of the output stream
      },
      injectStyles: true // whether to inject the WBS css
    }

    function getID() {
      if (location.hash == "") {
        return crypto.getRandomValues(new Uint32Array(1)).toString(36).substring(2, 8);
      } else {
        return location.hash.replace("#", "");
      }
    }

    //Config for the GUN GunStreamer
    var streamer_config = {
      dbRecord: "gunmeeting",//The root of the streams
      streamId: YOUR_ID,//The user id you wanna stream  
      gun: gunDB,//Gun instance
      debug: false,//For debug logs    
      url: "https://cdn.jsdelivr.net/gh/QVDev/GunStreamer@0.0.9/js/parser_worker.js"//webworker load remote
    }

    //GUN Streamer is the data side. It will convert data and write to GUN db
    const gunStreamer = new GunStreamer(streamer_config)

    if (user.is) {
      var wbs = new WBS('section', [OPTS])

      wbs.on('stream', function (stream) {
        console.log("received stream " + stream)
        startRecording(stream);
        let metaData = gunDB.get('metadata_' + YOUR_ID).put({ title: document.getElementById("title").value, streamId: YOUR_ID });
        gunDB.get('gunmeeting_metadata').set(metaData);
      })
      
      wbs.on('stopstream', function () {
        stopRecording();
        console.log("Stopped streaming");
      })
    } else {
      window.location.href = "auth.html?auth=signin"
    }
</script>
</html>
